name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        ruby-version: ['2.7', '3.0', '3.1', '3.4']

    name: Ruby ${{ matrix.ruby-version }} - All Rails versions
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: false

    - name: Cache gems
      uses: actions/cache@v4
      with:
        path: |
          vendor/bundle
          gemfiles/vendor/bundle
        key: ${{ runner.os }}-gems-${{ matrix.ruby-version }}-${{ hashFiles('**/Gemfile.lock', 'gemfiles/*.gemfile.lock', 'Appraisals') }}
        restore-keys: |
          ${{ runner.os }}-gems-${{ matrix.ruby-version }}-
          ${{ runner.os }}-gems-

    - name: Install dependencies
      run: |
        # Install appropriate Bundler version for Ruby compatibility
        if [[ "${{ matrix.ruby-version }}" == "2.7" ]] || [[ "${{ matrix.ruby-version }}" == "3.0" ]]; then
          gem install bundler -v "~> 2.4.0"
        else
          gem install bundler
        fi
        bundle config path vendor/bundle
        bundle install --jobs 4 --retry 3 --without development

    - name: Generate Appraisal gemfiles
      run: bundle exec appraisal install

    - name: Run tests
      run: |
        # Run tests against compatible Rails versions only
        case "${{ matrix.ruby-version }}" in
          "2.7")
            bundle exec appraisal rails-5.0,rails-5.1,rails-5.2,rails-6.0,rails-6.1,rails-7.0,rails-7.1 rake test
            ;;
          "3.0")
            bundle exec appraisal rails-6.0,rails-6.1,rails-7.0,rails-7.1 rake test
            ;;
          "3.1")
            bundle exec appraisal rails-6.1,rails-7.0,rails-7.1 rake test
            ;;
          "3.4")
            bundle exec appraisal rails-7.0,rails-7.1,rails-8.0 rake test
            ;;
        esac

    - name: Check gem build
      run: gem build rails_action_tracker.gemspec
      if: matrix.ruby-version == '3.4'

  # Security and quality checks
  security:
    runs-on: ubuntu-latest
    name: Security and Quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4'
        bundler-cache: true

    - name: Run bundle audit
      run: |
        gem install bundler-audit
        bundle audit --update
      continue-on-error: true

    - name: Install development dependencies
      run: |
        bundle config path vendor/bundle
        bundle install --jobs 4 --retry 3 --with development

    - name: Run RuboCop
      run: bundle exec rubocop --parallel --format github

    - name: Check for security vulnerabilities
      run: |
        gem install brakeman
        brakeman --rails4 --no-pager
      continue-on-error: true